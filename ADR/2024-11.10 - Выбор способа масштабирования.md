# Выбор способа масштабирования

**Дата:** 12 декабря 2024 г.  
**Статус:** Принято

## Контекст

С увеличением объема данных и числа пользователей (SCA02, SCA03, SCA04), а также с необходимостью обеспечения высокой доступности (AVA01) и отказоустойчивости (DUR04), возникает необходимость в эффективном управлении данными. Согласно прогнозам, единственный сервер базы данных не справится с увеличением нагрузки и требуется оптимизации для обеспечения высокой доступности и отказоустойчивости. Необходимость в быстром доступе к данным для пользователей из разных регионов также требует решения.

## Решение

Комбинированный подход (горизонтальное и вертикальное масштабирование) и региональное масштабирование (по странам) с репликацией.

## Рассмотренные варианты

- Использование облачных решений
- Автоматическое масштабирование

## Преимущества

- **Гибкость:** Можно оптимизировать ресурсы в зависимости от нагрузки.
- **Устойчивость:** Сочетание преимуществ обоих подходов.

## Недостатки

- **Сложность:** Управление и настройка могут быть более трудоемкими.

## Внедрение

### Начальная стадия

- Выбрали базу данных, такую как PostgreSQL, и используем Redis для кэширования.
- Выбрали стратегию регулярного анализа логов для выявления проблем с производительностью и возможных способов их устранения.

### Рост нагрузки

- По мере роста пользователей и нагрузки перейдем к горизонтальному масштабированию, добавляя новые серверы для обработки запросов и распределения нагрузки.
- Используем контейнеризацию, в качестве инструмента Docker, и оркестрацию (Kubernetes) для управления масштабируемыми экземплярами приложения.
- Выбрали использовать для балансировки нагрузки NGINX для распределения запросов между серверами.

### Мониторинг и оптимизация

- Выбрали систему мониторинга (Prometheus и Grafana) для отслеживания производительности и выявления узких мест.
- Наметили регулярно анализировать и оптимизировать архитектуру в зависимости от изменяющихся требований и нагрузки.

## Шардирование

Региональное шардирование позволяет распределить данные по различным странам СНГ, что может значительно улучшить производительность и снизить время отклика для пользователей, находящихся в разных странах. Внедрение шардирования базы данных PostgreSQL будет включать следующие компоненты:

- **Шардирование:** Использование шардирования для распределения нагрузки между несколькими экземплярами PostgreSQL. Каждый экземпляр будет обрабатывать запросы только для своей страны.
- **Репликация:** Настройка репликации для обеспечения отказоустойчивости. Каждая база данных страны будет иметь одну или несколько реплик, расположенных в разных дата-центрах.
- **Балансировка нагрузки:** Использование балансировщика нагрузки (например, Nginx) для распределения запросов между экземплярами баз данных в зависимости от географического положения пользователя.

Предлагается разместить по одному серверу в каждой из ключевых стран СНГ, с возможностью масштабирования по мере необходимости:

- Россия
- Казахстан
- Беларусь
- Украина
- Узбекистан
- Армения
- Киргизия
- Таджикистан

## Последствия

### Преимущества

- **Улучшение производительности:** Снижение времени отклика для пользователей из разных стран.
- **Повышение отказоустойчивости:** Благодаря репликации и распределению нагрузки.
- **Возможность масштабирования:** Система может легко адаптироваться к росту нагрузки.

### Недостатки

- **Усложнение архитектуры:** Необходимость в дополнительной настройке и мониторинге.
- **Проблемы с согласованностью данных:** Потенциальные сложности с синхронизацией данных между странами, требующие внедрения дополнительных механизмов.
